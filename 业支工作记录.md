



### 集团成员号码数据提取

```
!hui12345
```

```sql
drop table crm3_hzh_payment;
create table crm3_hzh_payment as      ----创建统付表
select a.*,b.state 号码当前状态,case when c.user_id is not null then 1 else 0 end 是否统付, 
c.expire_date 统付结束时间 from crm3_wc_zsy_temp2 a,zt_user b, 
(select * from SO1.ins_accrel_792@from_crmdba1_clone where pay_type=2) c 
where a.user_id=b.user_id(+) and a.user_id=c.user_id(+); 

drop table crm3_hzh_101;
create table crm3_hzh_101 as   ----从crm3_zt_sa中提取数据
select a.*,b.state_name,b.weigth,b.res_value,b.order_name,b.is_hitv,b.是否融小号副卡,
b.manufacturer_name,b.term_code,b.is_zkyj,b.zkyj_name,b.zkyj_expire,b.is_kd
from crm3_wc_101 a,crm3_zt_sa b where a.phone_id = b.phone_id

select a.*,b.是否统付,case when b.offer_id in ('310095400488',
'310095400489',
'310095400484',
'310095400485',
'310095400517',
'310095400623',
'310095400624',
'310095400625',
'310095400642',
'310095400643') then 1 else 0 end 是否组网  from crm3_hzh_101 a,crm3_hzh_payment b   where a.phone_id = b.bill_id 
```



​	





```SQL

drop table zt_temp5;
create table zt_temp5 as
selectdrop table crm3_hzh_payment;
create table crm3_hzh_payment as      ----创建统付表
select a.*,b.state 号码当前状态,case when c.user_id is not null then 1 else 0 end 是否统付, 
c.expire_date 统付结束时间 from crm3_wc_zsy_temp2 a,zt_user b, 
(select * from SO1.ins_accrel_792@from_crmdba1_clone where pay_type=2) c 
where a.user_id=b.user_id(+) and a.user_id=c.user_id(+); 

drop table crm3_hzh_101;
create table crm3_hzh_101 as   ----从crm3_zt_sa中提取数据
select a.*,b.state_name,b.weigth,b.res_value,b.order_name,b.is_hitv,b.是否融小号副卡,
b.manufacturer_name,b.term_code,b.is_zkyj,b.zkyj_name,b.zkyj_expire,b.is_kd
from crm3_wc_101 a,crm3_zt_sa b where a.phone_id = b.phone_id

select a.*,b.是否统付,case when b.offer_id in ('310095400488',
'310095400489',
'310095400484',
'310095400485',
'310095400517',
'310095400623',
'310095400624',
'310095400625',
'310095400642',
'310095400643') then 1 else 0 end 是否组网  from crm3_hzh_101 a,crm3_hzh_payment b   where a.phone_id = b.bill_id 


select * from crm3_hzh_payment

select * from crm3_hzh_101








drop table crm3_wc_101;
create table crm3_wc_101(phone_id varchar(30),company varchar(60));
---select * from crm3_wc_101 for update;

select count(*) from crm3_wc_101

drop table crm3_hzh_101;
create table crm3_hzh_101 as
select a.*,b.state_name,b.weigth,b.res_value,b.order_name,b.is_hitv,b.是否融小号副卡,
b.manufacturer_name,b.term_code,b.is_zkyj,b.zkyj_name,b.zkyj_expire,b.is_kd
from crm3_wc_101 a,crm3_zt_sa b where a.phone_id = b.phone_id


select * from crm3_zt_sa

select * from crm3_hzh_101

 select * from zt_zk_dtl
 
 select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate and state=1
 
 drop table crm3_hzh_czj;
 create table crm3_hzh_czj as 
 select * from jf.dr_ismg_l_20210303@jfxdcx where service_code = '106573027999'

 
  select * from jf.dr_ismg_l_20210303@jfxdcx
 
 execute immediate 'insert into zt_xd_temp2 
select a.bill_month,a.user_number,a.user_id,a.start_time,a.call_type,a.duration,a.opp_user_number
from jf.dr_gsm_792_'||p_bill_date||'@jfxdcx a 
inner join zt_temp5 b on a.opp_user_number=b.phone_id ';
```





提取三四月财政局短信发送

```sql
 Declare  
p_bill_date varchar(8);
b_date varchar(8);
e_date varchar(8);
m Number(4);
i Number;
begin
  Execute Immediate 'Truncate Table crm3_hzh_czj';
b_date:='20210301';
e_date:='20210409';
m:=to_date(e_date,'yyyymmdd')-to_date(b_date,'yyyymmdd');
Loop
p_bill_date  := to_char(to_date(e_date,'yyyymmdd')-m,'yyyymmdd');
 execute immediate 'insert into crm3_hzh_czj 
 select * from jf.dr_ismg_l_'||p_bill_date||'@jfxdcx a where a.SERVICE_CODE=''106573027999''';
 commit;
 Exit When m=0;
  m:=m-1;
  End Loop;
  End;
  
  select * from crm3_hzh_czj order by bill_month
  
  
----分组查询  
select bill_month, count(bill_month) 数量 from crm3_hzh_czj group by bill_month order by bill_month
```





瑞昌市卫生健康会所

```sql
--select * from xg.sys_city@from_ggkdb1_clone 

drop table crm3_hzh_health3;
create table crm3_hzh_health3 as 
select bill_month,process_time, opp_number,opp_hplmn2 from jf.dr_ismg_l_20210301@jfxdcx a where a.SERVICE_CODE='106575361046';
select  * from crm3_hzh_health3;

 Declare  
p_bill_date varchar(8);
b_date varchar(8);
e_date varchar(8);
m Number(4);
i Number;
begin
  Execute Immediate 'Truncate Table crm3_hzh_health3';
b_date:='20210301';
e_date:='20210331';
m:=to_date(e_date,'yyyymmdd')-to_date(b_date,'yyyymmdd');
Loop
p_bill_date  := to_char(to_date(e_date,'yyyymmdd')-m,'yyyymmdd');
 execute immediate 'insert into crm3_hzh_health3 
 select bill_month,process_time, opp_number,opp_hplmn2 from jf.dr_ismg_l_'||p_bill_date||'@jfxdcx a where a.SERVICE_CODE=''106575361046''';
 commit;
 Exit When m=0;
  m:=m-1;
  End Loop;
  End;
  
  select * from crm3_hzh_health3
  
  
    select a.*,b.city_name from crm3_hzh_health2 a,xg.sys_city@from_ggkdb1_clone b where b.city_code = a.opp_hplmn2
```



~~~sql
----电动摩托数据提取


---drop table crm3_hzh_motorcycle;
--create table crm3_hzh_motorcycle(phone varchar(30),package_id varchar(60),level_id varchar(10));
--select * from crm3_hzh_motorcycle

--drop table crm3_hzh_iot;
--create table crm3_hzh_iot(phone varchar(30));
--select * from crm3_hzh_iot

drop table crm3_hzh_temporary;
create table crm3_hzh_temporary as 
select a.org_id ,a.bill_id,b.package_id from ams1.am_payment_792_202012@from_bossdba1_clone a,crm3_hzh_motorcycle b  where a.bill_id = b.phone;

----select bill_id ,count(bill_id) 数量 from crm3_hzh_temporary group by bill_id 
----select * from ams1.am_payment_792_202102@from_bossdba1_clone
----select * from crm3_hzh_temporary

select a.organize_name,b.用户数 from sec.SEC_ORGANIZE@FROM_GGKDBb_adg a,(select org_id,count(bill_id) as 用户数 from crm3_hzh_temporary group by org_id) b where 
a.organize_id = b.org_id
```

---drop table crm3_hzh_motorcycle;
--create table crm3_hzh_motorcycle(phone varchar(30),package_id varchar(60),level_id varchar(10));
--select * from crm3_hzh_motorcycle

--drop table crm3_hzh_iot;
--create table crm3_hzh_iot(phone varchar(30));
--select * from crm3_hzh_iot

drop table crm3_hzh_temporary;
create table crm3_hzh_temporary as 
select a.org_id ,a.bill_id,b.package_id from ams1.am_payment_792_202012@from_bossdba1_clone a,crm3_hzh_motorcycle b  where a.bill_id = b.phone;

----select bill_id ,count(bill_id) 数量 from crm3_hzh_temporary group by bill_id 
----select * from ams1.am_payment_792_202102@from_bossdba1_clone
----select * from crm3_hzh_temporary

select a.organize_name,b.用户数 from sec.SEC_ORGANIZE@FROM_GGKDBb_adg a,(select org_id,count(bill_id) as 用户数 from crm3_hzh_temporary group by org_id) b where 
a.organize_id = b.org_id
~~~





![image-20210421173126544](C:\Users\The man\AppData\Roaming\Typora\typora-user-images\image-20210421173126544.png)







```sql
 集团成员号码数据提取(修改后)

​```sql
drop table crm3_hzh_payment;
create table crm3_hzh_payment as      ----创建统付表
select a.*,b.state 号码当前状态,case when c.user_id is not null then 1 else 0 end 是否统付, 
c.expire_date 统付结束时间 from crm3_wc_zsy_temp2 a,zt_user b, 
(select * from SO1.ins_accrel_792@from_crmdba1_clone where pay_type=2) c 
where a.user_id=b.user_id(+) and a.user_id=c.user_id(+); 

drop table crm3_hzh_101;
create table crm3_hzh_101 as   ----从crm3_zt_sa中提取数据
select a.*,b.state_name,b.weigth,b.res_value,b.order_name,b.is_hitv,b.是否融小号副卡,
b.manufacturer_name,b.term_code,b.is_zkyj,b.zkyj_name,b.zkyj_expire,b.is_kd
from crm3_wc_101 a,crm3_zt_sa b where a.phone_id = b.phone_id

select a.*,b.是否统付,case when b.offer_id in ('310095400488',
'310095400489',
'310095400484',
'310095400485',
'310095400517',
'310095400623',
'310095400624',
'310095400625',
'310095400642',
'310095400643') then 1 else 0 end 是否组网  from crm3_hzh_101 a,crm3_hzh_payment b   where a.phone_id = b.bill_id 
​```
---drop table crm3_hzh_payment;
---create table crm3_hzh_payment as      ----创建统付表
--select a.*,b.state 号码当前状态,case when c.user_id is not null then 1 else 0 end 是否统付, 
--c.expire_date 统付结束时间 from crm3_wc_zsy_temp2 a,zt_user b, 
--(select * from SO1.ins_accrel_792@from_crmdba1_clone where pay_type=2) c 
--where a.user_id=b.user_id(+) and a.user_id=c.user_id(+); 



drop table crm3_hzh_101;
create table crm3_hzh_101 as   ----从crm3_zt_sa中提取数据
select a.*,b.state_name,b.weigth,b.order_name,b.is_hitv,b.是否融小号副卡,
b.manufacturer_name,b.term_code,b.is_zkyj,b.zkyj_name,b.zkyj_expire,b.is_kd,b.is_5g
from crm3_wc_101 a,crm3_zt_sa b where a.phone_id = b.phone_id(+);
--select distinct phone_id from crm3_wc_101
--select distinct phone_id from crm3_wc_101
drop table crm3_hzh_average;
create table crm3_hzh_average as 
select b.phone_id, (b.fee_1 + b.fee_2 + b.fee_3) / 3 as ave from crm3_zt_sa b
select distinct phone_id from crm3_hzh_average

select distinct a.phone_id,a.company, a.state_name,a.weigth,a.order_name,a.is_hitv,a.是否融小号副卡,
a.manufacturer_name,a.term_code,a.is_kd,a.is_5g,a.ave,a.is_zkyj,a.zkyj_name,a.zkyj_expire,b.是否统付,b.name, case when b.offer_id in ('310095400488',
'310095400489',
'310095400484',
'310092300013',
'310092300092',
'310092300094',
'310095400375',
'310095400374',
'310092300115',
'310095400541',
'310092300174'
) then 1 else 0 end 是否组网 from crm3_hzh_102 a,crm3_hzh_payment b where a.phone_id = b.bill_id(+)


(select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate and state=1) c
,c.order_name,c.expire_date         and c.user_id = b.user_id

drop table crm3_hzh_102;
create table crm3_hzh_102 as 
select distinct a.phone_id,a.company, a.state_name,a.weigth,a.order_name,a.is_hitv,a.是否融小号副卡,
a.manufacturer_name,a.term_code,a.is_kd,a.is_5g,a.is_zkyj,a.zkyj_name,a.zkyj_expire,b.ave from crm3_hzh_101 a,crm3_hzh_average b where a.phone_id = b.phone_id(+)

select * from crm3_hzh_102
select * from crm3_hzh_101

select * from crm3_hzh_payment order by offer_id desc where offer_id = '310095400674'

select * from crm3_wc_101

select * from crm3_zt_sa

select distinct offer_id from crm3_Wc_lxx_temp1
(select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate and state=1)


drop table crm3_hzh_lastone;
create table crm3_hzh_lastone as 
select distinct a.phone_id,a.company, a.state_name,a.weigth,a.order_name,a.is_hitv,a.是否融小号副卡,
a.manufacturer_name,a.term_code,a.is_kd,a.is_5g,a.ave,b.是否统付,b.name, case when b.offer_id in ('310095400488',
'310095400489',
'310095400484',
'310092300013',
'310092300092',
'310092300094',
'310095400375',
'310095400374',
'310092300115',
'310095400541',
'310092300174'
) then 1 else 0 end 是否组网 from crm3_hzh_102 a,crm3_hzh_payment b where a.phone_id = b.bill_id(+)







5G,折扣押金，月均消费，押金名称
```



```sql
select * from product.up_item_kind_rel@from_ggkdb1_clone where kind_id = '195110000271'


关于物联网消防烟感套餐促销互斥押金代码的提取申请
```

```sql
关于永修县第一中学教职工成员数据提取申请

--drop table crm3_hzh_staff;
--create table crm3_hzh_staff(name varchar(10),phone_id varchar(20),group_id varchar(20));
select * from crm3_hzh_staff;
--update crm3_hzh_staff set phone_id='13870231990' where crm3_hzh_staff.name = '王玉霞';
select * from crm3_zt_sa where phone_id = '13879203152'
```

```
select distinct b.phone_id,b.name,b.group_id ,a.state_name,a.order_name,a.is_kd,a.is_hitv,a.zkyj_name,a.zkyj_expire,(a.fee_1 + a.fee_2 + a.fee_3) / 3 as ARPU,
(a.volume_1 + a.volume_2+ a.volume_3)/3 as 话务,(c.over_flow+ c.flow_2g+ c.flow_night+ c.flow_3g+ c.flow_4g + c.flow_5g) as 流量
 from 
crm3_zt_sa a ,crm3_hzh_staff b,zt_gprs_202104 c where a.phone_id(+) = b.phone_id and b.phone_id = c.user_number(+);
```

```

----关于德安县农商行消费提取申请
drop table crm3_hzh_customer;
create table crm3_hzh_customer(phone_id varchar(20),user_id varchar(20));

select distinct  a.*,b.order_name from crm3_hzh_customer a inner join (select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and state=1) b
on  a.user_id = b.user_id

select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate and state=1

select * from zt_gprs_202104

select b.* ,a.order_name,a.zdyj_name,a.fee_1 as 四月费用 from crm3_zt_sa a right join crm3_hzh_customer b on a.phone_id=b.phone_id
```

```sql

select a.bill_month,count(bill_month) as total from jf.dr_ismg_l_20210203@jfxdcx a where user_number = '10005720078' group by a.bill_month          --关于九江住房公积金MAS短信2-3月发送条数明细申请
drop table crm3_hzh_housefund;
create table crm3_hzh_housefund(bill_month varchar(60),total varchar(60));


 Declare  
p_bill_date varchar(8);
b_date varchar(8);
e_date varchar(8);
m Number(4);
i Number;
begin
  Execute Immediate 'Truncate Table crm3_hzh_housefund';
b_date:='20210201';
e_date:='20210428';
m:=to_date(e_date,'yyyymmdd')-to_date(b_date,'yyyymmdd');
Loop
p_bill_date  := to_char(to_date(e_date,'yyyymmdd')-m,'yyyymmdd');
 execute immediate 'insert into crm3_hzh_housefund 
 select a.bill_month,count(bill_month) as total from jf.dr_ismg_l_'||p_bill_date||'@jfxdcx a where a.user_number=''10005720078''  group by a.bill_month';
 commit;
 Exit When m=0;
  m:=m-1;
  End Loop;
  End;
  
  select * from crm3_hzh_housefund;
```

```sql

--关于国网共青城市供电责任有限公司电力抄表卡相关数据提取申请 
--drop table crm3_hzh_powersupply;
--create table crm3_hzh_powersupply(phone_id varchar(20));
select * from crm3_hzh_powersupply

select distinct b.phone_id,a.tongyong from zt_gprs_202103 a right join crm3_hzh_powersupply b on a.user_number = b.phone_id
```

```sql

--关于国网共青城市供电责任有限公司电力抄表卡相关数据提取申请 
--drop table crm3_hzh_powersupply;
--create table crm3_hzh_powersupply(phone_id varchar(20));
select * from crm3_hzh_powersupply

select b.phone_id,sum(total单位kb)  as 二月流量,b.imei from 
(select b.phone_id,a.rating_res total单位kb,a.imei from zt_gprs_202102 a right join crm3_hzh_powersupply b on a.user_number = b.phone_id) b 
group by b.phone_id,b.imei

select b.phone_id,sum(total单位kb) as 三月流量 from 
(select b.phone_id,a.rating_res total单位kb,a.imei from zt_gprs_202103 a right join crm3_hzh_powersupply b on a.user_number = b.phone_id) b 
group by b.phone_id


--drop table crm3_hzh_flowstati;
--create table crm3_hzh_flowstati as
select m.*,n.二月流量,n.imei from (select e.*,f.三月流量 from (select b.phone_id,sum(total单位kb)  as 四月流量 from 
(select b.phone_id,a.rating_res total单位kb,a.imei from zt_gprs_202104 a right join crm3_hzh_powersupply b on a.user_number = b.phone_id) b 
group by b.phone_id) e right join 
(select b.phone_id,sum(total单位kb)  as 三月流量 from 
(select b.phone_id,a.rating_res total单位kb,a.imei from zt_gprs_202103 a right join crm3_hzh_powersupply b on a.user_number = b.phone_id) b 
group by b.phone_id) f on e.phone_id = f.phone_id) m right join
(select b.phone_id,sum(total单位kb)  as 二月流量,b.imei from 
(select b.phone_id,a.rating_res total单位kb,a.imei from zt_gprs_202102 a right join crm3_hzh_powersupply b on a.user_number = b.phone_id) b 
group by b.phone_id,b.imei) n on m.phone_id = n.phone_id

---select a.state,b.* from zt_user a right join crm3_hzh_powersupply b on a.phone_id = b.phone_id

select a.*,b.state from crm3_hzh_flowstati a left join zt_user b on a.phone_id = b.phone_id

select * from zt_gprs_202103
```

```
user_number：  主叫， user_opp_number:被叫    当type为1的时候，为零则相反
```

```sql
drop table crm3_hzh_contact;
create table crm3_hzh_contact(tu1621493103250_key varchar(20),tu16214931032501 varchar(20),tu16214931032502 varchar(20),tu16214931032503 varchar(20),
tu16214931032504 varchar(20),row_num varchar(20),duration varchar(20));

 
  Declare  
p_bill_date varchar(8);
b_date varchar(8);
e_date varchar(8);                  --关于提取看管人10分满意宣传接触率的明细申请
m Number(4);
i Number;
begin
  Execute Immediate 'Truncate Table crm3_hzh_contact';
b_date:='20210501';
e_date:='20210520';
m:=to_date(e_date,'yyyymmdd')-to_date(b_date,'yyyymmdd');
Loop
p_bill_date  := to_char(to_date(e_date,'yyyymmdd')-m,'yyyymmdd');
 execute immediate 'insert into crm3_hzh_contact
 select b.*,duration  from jf.dr_gsm_792_'||p_bill_date||'@jfxdcx a inner join datamart.U1621493103250 b
 on a.user_number = b.tu1621493103250_key and a.opp_user_number = b.tu16214931032504';
 commit;
 Exit When m=0;
  m:=m-1;
  End Loop;
  End;
  
select a.*,case when b.tu1621493103250_key = a.tu1621493103250_key then 1 else 0 end 是否通话 from datamart.U1621493103250 a left join (select a.tu1621493103250_key from crm3_hzh_contact a group by tu1621493103250_key) b
  on a.tu1621493103250_key = b.tu1621493103250_key;
```

```sql
--  关于提取供电公司4月物联卡消费数据的申请！

--drop table crm3_hzh_ducangpower;
--create table crm3_hzh_ducangpower(phone_id varchar(20));
select * from crm3_hzh_ducangpower

drop table crm3_hzh_ducangflow;
create table crm3_hzh_ducangflow as
select m.*,n.五月流量 from (select e.*,f.三月流量 from (select b.phone_id,sum(total单位kb)  as 四月流量 from 
(select b.phone_id,a.rating_res total单位kb,a.imei from zt_gprs_202104 a right join crm3_hzh_ducangpower b on a.user_number = b.phone_id) b 
group by b.phone_id) e right join 
(select b.phone_id,sum(total单位kb)  as 三月流量 from 
(select b.phone_id,a.rating_res total单位kb,a.imei from zt_gprs_202103 a right join crm3_hzh_ducangpower b on a.user_number = b.phone_id) b 
group by b.phone_id) f on e.phone_id = f.phone_id) m right join
(select b.phone_id,sum(total单位kb)  as 五月流量 from 
(select b.phone_id,a.rating_res total单位kb from zt_gprs_202105 a right join crm3_hzh_ducangpower b on a.user_number = b.phone_id) b 
group by b.phone_id) n on m.phone_id = n.phone_id


select * from crm3_hzh_ducangflow

select f.*,g.三月流量,g.四月流量,g.五月流量  from (select b.phone_id, a.order_name, case when  a.实时余额 < 0 then '是' else '否' end 是否欠费 ,a.state_name,fee_1 四月消费 from crm3_zt_sa a right join 
crm3_hzh_ducangpower b on a.phone_id = b.phone_id) f right join crm3_hzh_ducangflow g on f.phone_id = g.phone_id

```

```sql
--  取湖口县九钢公司员工手机号码的相关业务数据

--drop table crm3_hzh_steel2;
--create table crm3_hzh_steel2(company varchar(20),phone_id varchar(20));
select * from crm3_hzh_steel
select * from crm3_hzh_steel2


select * from xg.sys_city@from_ggkdb1_clone 
select b.*,a.order_name,a.order_name_next,a.state_name,a.county_name,a.is_kd,a.is_hitv,a.zdyj_name,a.zdyj_offer,a.zdyj_expire,a.user_id
from crm3_zt_sa a right join crm3_hzh_steel b on a.phone_id = b.phone_id
--彩铃
select * from so1.ins_offer_792@from_crmdba1_clone where state = 1 and expire_date>sysdate and offer_id = '212035012000'
--宽带
select * from zt_user_broadband

--宽带促销名称
select d.*,c.产品名称 as 宽带促销名称 from zt_user_broadband c right join (select b.*,a.order_name,a.order_name_next,a.state_name,a.county_name,a.is_kd,a.is_hitv,a.zdyj_name,a.zdyj_offer,a.zdyj_expire,a.acct_id,a.user_id
from crm3_zt_sa a right join crm3_hzh_steel b on a.phone_id = b.phone_id) d on c.号码 = d.phone_id and d.phone_id is not null

--添加是否彩铃
drop table crm3_hzh_crbt;
create table crm3_hzh_crbt as
select m.*,case when m.user_id = n.user_id then 1 else 0 end 是否彩铃 from (select * from so1.ins_offer_792@from_crmdba1_clone where state = 1 and expire_date>sysdate and offer_id = '212035012000') n right join 
(select d.*,c.产品名称 as 宽带促销名称 from zt_user_broadband c right join (select b.*,a.order_name,a.order_name_next,a.state_name,a.county_name,a.is_kd,a.is_hitv,a.zdyj_name,a.zdyj_offer,a.zdyj_expire,a.user_id
from crm3_zt_sa a right join crm3_hzh_steel b on a.phone_id = b.phone_id) d on c.号码 = d.phone_id and d.phone_id is not null) m on m.user_id = n.user_id

select * from crm3_hzh_crbt

--集团网 
select * from zt_vpmn_product

select p.*,o.user_id from so1.ins_prod_792@from_crmdba1_clone o right join  zt_vpmn_product p on  o.prod_id = p.product_item_id

select  n.*,case when n.prod_id = m.product_item_id then 1 else 0 end 是否集团网,m.name from zt_vpmn_product m right join (select g.*,f.prod_id from so1.ins_prod_792@from_crmdba1_clone f right join (select b.*,a.order_name,a.order_name_next,a.state_name,a.county_name,a.is_kd,a.is_hitv,a.zdyj_name,a.zdyj_offer,a.zdyj_expire,a.user_id
from crm3_zt_sa a right join crm3_hzh_steel b on a.phone_id = b.phone_id) g on f.user_id = g.user_id) n on n.prod_id = m.product_item_id

select * from crm3_zt_sa

select z.*,h.name,case when z.user_id = h.user_id then 1 else 0 end 是否集团网 from crm3_hzh_crbt z left join 
(select p.*,o.user_id from so1.ins_prod_792@from_crmdba1_clone o right join  zt_vpmn_product p on  o.prod_id = p.product_item_id) h on 
z.user_id = h.user_id

drop table crm3_hzh_jiugang;
create table crm3_hzh_jiugang as 
select z.*,h.name,case when z.user_id = h.user_id then 1 else 0 end 是否集团网 from crm3_hzh_crbt z left join 
(select p.*,o.user_id from so1.ins_prod_792@from_crmdba1_clone o right join  zt_vpmn_product p on  o.prod_id = p.product_item_id) h on 
z.user_id = h.user_id



select a.*,b.order_name 所有有效活动押金明细,b.offer_id from crm3_hzh_jiugang a left join 
(select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate) b 
on a.user_id = b.user_id
```

### 五月二十二号



```sql
--小微取数需求
--select * from crm3_dnp_lc_plan_1 where REGEXP_LIKE(offer_value,'18')

drop table crm3_hzh_small;
create table crm3_hzh_small(s_id varchar(20),s_name varchar(20),s_type varchar(20),s_typecode varchar(20),
s_tel varchar(20),s_pname varchar(20),s_citycode varchar(20),s_cityname varchar(20),s_wanggename varchar(20),s_adname varchar(20));
select * from crm3_hzh_small
```

### 五月二十六号

```sql
--永修气象局
--select * from product.up_item_kind_rel@from_ggkdb1_clone

--drop table crm3_hzh_weather;
--create table crm3_hzh_weather(phone_id varchar(20),company varchar(20))
select * from crm3_hzh_weather
select b.*,a.order_name,a.fee_now,a.create_date,a.fee_1,a.fee_2,a.fee_3 from crm3_zt_sa a right join crm3_hzh_weather b on a.phone_id = b.phone_id
```

```sql
--drop table crm3_hzh_cityUsers;
--create table crm3_hzh_cityUsers(product_item_id varchar(60),name_id varchar(100));
select * from crm3_hzh_cityUsers




select * from ams1.am_payment_792_202012@from_bossdba1_clone               --关于物联网电摩卫士促销互斥明细的提取

select * from crm3_zt_sa a where a.weigth < 31
select * from zt_gprs_202104

select * from ams1.am_payment_792_202104@from_bossdba1_clone
select * from product.up_item_kind_rel@from_ggkdb1_clone
```

```javascript
select a.bill_month,count(bill_month) as total from jf.dr_ismg_l_20210419@jfxdcx a where cust_id = '39202002724795' group by a.bill_month    
select * from jf.dr_ismg_l_20210327@jfxdcx where user_number = '99269422142'     --关于共青城市人民政府信息化工作办公室MAS产品相关数据提取申请
drop table crm3_hzh_peoplesGov;
create table crm3_hzh_peoplesGov(bill_month varchar(60),total varchar(60));
```

```sql
--为分析萍钢用户消费情况，请帮忙提取附件用户2021年1、2、3、4月每月的MOU及DOU情况（mou通话，dou流量）
--drop table crm3_hzh_pingsteel;
--create table crm3_hzh_pingsteel(phone_id varchar(20));                         
drop table crm3_hzh_pingsteel2;
create table crm3_hzh_ping_steel2 as
select * from crm3_hzh_pingsteel where phone_id is not null

select * from crm3_hzh_ping_steel2


select q.*,w.二月mou,w.二月dou,e.三月mou,e.三月dou,r.四月mou,r.四月dou from
(select a.phone_id,a.mou 一月mou,a.flow 一月dou from zt_user_fee_202101 a right join crm3_hzh_ping_steel2 b on a.phone_id = b.phone_id) q  
left join 
(select a.phone_id,a.mou 二月mou,a.flow 二月dou from zt_user_fee_202102 a right join crm3_hzh_ping_steel2 b on a.phone_id = b.phone_id) w on q.phone_id = w.phone_id
left join
(select a.phone_id,a.mou 三月mou,a.flow 三月dou from zt_user_fee_202103 a right join crm3_hzh_ping_steel2 b on a.phone_id = b.phone_id) e on q.phone_id = e.phone_id
left join 
(select a.phone_id,a.mou 四月mou,a.flow 四月dou from zt_user_fee_202104 a right join crm3_hzh_ping_steel2 b on a.phone_id = b.phone_id) r on q.phone_id = r.phone_id

```

### 六月九号

```sql
select * from so1.ins_prod_792@from_crmdba1_clone

select a.*,b.user_id  from crm3_hzh_cityUsers a left join so1.ins_prod_792@from_crmdba1_clone b on a.product_item_id = b.prod_id

select * from crm3_zt_sa

select * from zt_user

select * from so1.ins_prod_792@from_crmdba1_clone

问题： 上面写着提取摩托车的数据，下面却是全市的数据，   注： ORG_ID_NOW 可以在zt_user里面找
	  2、你要的这格式是根据什么来匹配的，近三个月收入是什么意思？
	  
	  首先要是0792的，然后再
	  
	  注：请审核需求后再发过来
```

![image-20210609173312497](C:\Users\The man\AppData\Roaming\Typora\typora-user-images\image-20210609173312497.png)

```sql
--关于集团客户部IMS固话新增、销户和变更明细取数的申请
drop table zt_tmp;
create table zt_tmp as
select a.user_id,a.prod_id,a.offer_inst_id,a.op_id,a.org_id,a.create_date,b.phone_id,b.order_name
from so1.ins_prod_792@from_crmdba1_clone a 
inner join zt_user b on a.user_id=b.user_id where prod_id='223201340001' and expire_date>sysdate;

drop table zt_tmp1;
create table zt_tmp1 as
select distinct a.offer_inst_id,b.user_id
from zt_tmp a
inner join so1.ins_offer_792@from_crmdba1_clone b on a.offer_inst_id=b.offer_inst_id;

select * from zt_tmp;
select * from zt_tmp1;

--select * from zt_user;



drop table zt_tmp2;
create table zt_tmp2 as
select distinct a.*,c.staff_name,d.organize_name,b.user_id user_id1
from zt_tmp a
left join zt_tmp1 b on a.offer_inst_id=b.offer_inst_id
left join sec.sec_staff@from_ggkdbb_adg c on a.op_id=c.staff_id
left join sec.sec_organize@from_ggkdbb_adg d on a.org_id=d.organize_id;

select * from zt_tmp2;

drop table zt_tmp3;
create table zt_tmp3 as
select a.*,b.county_code county_code_jt,b.group_id,b.party_name group_name
from zt_tmp2 a
left join (
select distinct c.county_code,b.organization_id,c.party_name,a.*
from  so1.insx_group_order_info@from_crmdba1_clone a
inner join PARTY.CB_ORGANIZATION@FROM_GGKDB1_CLONE b on a.group_id=b.group_id
inner join PARTY.CB_GROUP_PARTY@FROM_GGKDB1_CLONe c on b.organization_id=c.party_id) b on a.user_id1=b.user_id;

select * from zt_tmp3;

select * from zt_user_fee_202012;

select a.*,b.user_consume 十二月消费,c.user_consume 一月消费,d.user_consume 二月消费,e.user_consume 三月消费,f.user_consume 四月消费,g.user_consume 五月消费 
from zt_tmp3 a 
left join  zt_user_fee_202012 b on a.phone_id = b.phone_id
left join  zt_user_fee_202101 c on a.phone_id = c.phone_id
left join  zt_user_fee_202102 d on a.phone_id = d.phone_id
left join  zt_user_fee_202103 e on a.phone_id = e.phone_id
left join  zt_user_fee_202104 f on a.phone_id = f.phone_id
left join  zt_user_fee_202105 g on a.phone_id = g.phone_id;

```

```sql
--关于物联网电摩卫士促销互斥明细的提取申请

select * from product.up_item_kind_rel@from_ggkdb1_clone where kind_id not in ('195110000292')
drop table crm3_hzh_someData;
create table crm3_hzh_someData as
select q.* from 
(select distinct a.user_id from so1.ins_prod_792@from_crmdba1_clone a right join 
(select * from product.up_item_kind_rel@from_ggkdb1_clone where kind_id not in ('195110000292')) b
on a.prod_id = b.product_item_id) p inner join (select user_id,county_code,phone_id,order_name,create_date,organize_name,org_name_ck,
(fee_1+fee_2+fee_3) as 近三年月消费, org_id,kg_name,kg_phone
from crm3_zt_sa where weigth > 31) q
on p.user_id = q.user_id


select a.*,b.org_id_now from crm3_hzh_someData a left join zt_user b on a.phone_id = b.phone_id
```

```sql
--帮集客黄芳芳提取数据，另外一部分在张挺发的邮件里面
select * from zt_tmp3;

select * from zt_user_fee_202012;

select a.*,b.user_consume 十二月消费,c.user_consume 一月消费,d.user_consume 二月消费,e.user_consume 三月消费,f.user_consume 四月消费,g.user_consume 五月消费 
from zt_tmp3 a 
left join  zt_user_fee_202012 b on a.phone_id = b.phone_id
left join  zt_user_fee_202101 c on a.phone_id = c.phone_id
left join  zt_user_fee_202102 d on a.phone_id = d.phone_id
left join  zt_user_fee_202103 e on a.phone_id = e.phone_id
left join  zt_user_fee_202104 f on a.phone_id = f.phone_id
left join  zt_user_fee_202105 g on a.phone_id = g.phone_id;
```

```sql
select * from crm3_hzh_peoplesGov

select a.bill_month,count(bill_month) as total from jf.dr_ismg_l_20210203@jfxdcx a where user_number = '10005720078' group by a.bill_month          --关于共青城市人民政府信息化工作办公室MAS产品相关数据提取申请4月、5月
drop table crm3_hzh_peoplesGov;
create table crm3_hzh_peoplesGov(start_time varchar(60),opp_number varchar(60)，message_length varchar(60),条数 varchar(60),计费金额 varchar(60));


 Declare  
p_bill_date varchar(8);
b_date varchar(8);
e_date varchar(8);                         
m Number(4);
i Number;
begin
  Execute Immediate 'Truncate Table crm3_hzh_peoplesGov';
b_date:='20210401';
e_date:='20210531';
m:=to_date(e_date,'yyyymmdd')-to_date(b_date,'yyyymmdd');
Loop
p_bill_date  := to_char(to_date(e_date,'yyyymmdd')-m,'yyyymmdd');
 execute immediate 'insert into crm3_hzh_peoplesGov 
 select a.start_time,a.opp_number,a.message_length,a.条数,a.计费金额 from (select start_time,opp_number,message_length,case when opp_number is not null then 1 else 0 end 条数,
 (charge1+charge2+charge3+charge4-charge1_disc-charge2_disc-charge3_disc-charge4_disc) as 计费金额
from jf.dr_ismg_l_'||p_bill_date||'@jfxdcx  where user_number=''99269511959'') a ';
 commit;
 Exit When m=0;
  m:=m-1;
  End Loop;
  End;
  
  select * from crm3_hzh_housefund;
    select * from crm3_hzh_peoplesGov;
```

### 六月二十四日

```
drop table crm3_hzh_duchang88;
create table crm3_hzh_duchang88 as
select county_code,phone_id,user_id,order_name,create_date,case when to_char(create_date,'yyyymmdd') < '20200623' then 1 else 0 end 入网是否超12个月, 
org_id,organize_name,org_id_ck,org_name_ck
from crm3_zt_sa where county_code = '9217' and res_value < 88 and to_char(create_date,'yyyymmdd') < '20200623'


select * from crm3_zt_sa where county_code = '9217' and res_value <= 88 and to_char(create_date,'yyyymmdd') < '20200623'

select * from zt_gprs_202103

select z.*,case when z.user_id = h.user_id then 1 else 0 end 是否办理流量包活动 from 

(select * from crm3_hzh_duchang88 a left join
(select phone_id,flow 三月流量,case when ctc_flow_fee>0 then 1 else 0 end 三月是否流量超套餐,ctc_flow_fee 三月超套餐金额 
from zt_user_fee_202103 where county_code = '9217') q on a.phone_id = q.phone_id
left join
(select phone_id,flow 四月流量,case when ctc_flow_fee>0 then 1 else 0 end 四月是否流量超套餐,ctc_flow_fee 四月超套餐金额 
from zt_user_fee_202104 where county_code = '9217') w on a.phone_id = w.phone_id
left join
(select phone_id,flow 五月流量,case when ctc_flow_fee>0 then 1 else 0 end 五月是否流量超套餐,ctc_flow_fee 五月超套餐金额 
from zt_user_fee_202105 where county_code = '9217') e on a.phone_id = e.phone_id) z
left join 
(select * from so1.ins_offer_792@from_crmdba1_clone where expire_date>sysdate and state=1 and offer_id in
('212080720876',
'212080720877',
'212080720878',
'212080720879',
'212080721401',
'212080721402',
'212080721403',
'212080721410',
'212080720856',
'212080720857',
'212080720858',
'212080720859')) h on z.user_id = h.user_id

select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate and state=1) c

```

### 6月三十日

```sql
请市场部帮忙提取九钢用户近5个月的流量、通话、账单数据，谢谢！
select distinct TU1625041794179_KEY phone_id from datamart.U1625041794179



select a.*,c.user_consume 一月消费,c.flow 一月流量,c.mou 一月通话,
d.user_consume 二月消费,d.flow 二月流量,d.mou 二月通话,
e.user_consume 三月消费,e.flow 三月流量,e.mou 三月通话,
f.user_consume 四月消费,f.flow 四月流量,f.mou 四月通话,
g.user_consume 五月消费,g.flow 五月流量,g.mou 五月通话 
from (select distinct TU1625041794179_KEY phone_id from datamart.U1625041794179) a 
left join  zt_user_fee_202101 c on a.phone_id = c.phone_id
left join  zt_user_fee_202102 d on a.phone_id = d.phone_id
left join  zt_user_fee_202103 e on a.phone_id = e.phone_id
left join  zt_user_fee_202104 f on a.phone_id = f.phone_id
left join  zt_user_fee_202105 g on a.phone_id = g.phone_id;

```

```sql
关于提取供电物联卡消费的申请
select t408.PHONE_ID A15420051685948 from MART792.CRM3_ZT_SA t408, 
(select distinct TU1625121838024_KEY phone_id from datamart.U1625121838024) 
UP67 where t408.PHONE_ID = UP67.TU1625121838024_KEY

select z.*,c.user_consume 五月消费,c.flow 五月流量 from 
(select b.phone_id,a.user_id,a.order_name,case when a.实时余额 < 0 then '是' else '否' end 是否欠费 ,a.state_name,a.fee_1 六月消费,a.fee_2 五月消费 from 
crm3_zt_sa a right join (select distinct TU1625121838024_KEY phone_id from datamart.U1625121838024) b 
 on a.phone_id = b.phone_id) z
left join  zt_user_fee_202105 c
on z.phone_id = c.phone_id 
left join zt_user_fee_202106 d
on z.phone_id = d.phone_id
 

select * from zt_gprs_202106

select * from crm3_zt_sa

select distinct TU1625121838024_KEY phone_id from datamart.U1625121838024

select * from so1.ins_offer_792@from_crmdba1_clone where expire_date>sysdate
```

### 七月二号

```sql
关于6月故障退费、质差小区常驻用户提取申请
先用-把CGI拆分成四列，把最后两列分别转化成十六进制，然后把最后两项合并在一起，再对合并在一起的数转化成十进制数，把最后得出来的十进制数去匹配zt_user_work_home_30  这个表中的work_ci
注意：转十六进制：=DEC2HEX(G4)     转十进制： =DEC2HEX(H4,2)    注意转成十六进制要两位

select a.serv_no,b.区县,b.CGI from zt_user_work_home_30 a ,(select tu1625473356138_key 区县,tu16254733561381 CGI, replace(tu16254733561382,'	','') work_ci from datamart.U1625473356138) b
 where a.work_ci = b.work_ci
 需要添加区县以及CGI
```

```
关于提取2021年6月集团单位证件开户数据的申请
drop table hzh_temp;
create table hzh_temp as
select cert_type,cert_code,a.user_id,b.phone_id,b.county_code,b.op_id,b.org_id,b.create_date,b.offer_id plan_id,b.order_name plan_name,b.user_type
from sf.insx_cert_user_rel_OTH@from_crmdba1_clone a 
inner join zt_user b on a.user_id=b.user_id where cert_type in(19,24,50,57) and a.region_id=792 and to_char(b.create_date,'yyyymm') = '202106';


drop table hzh_temp1;
create table hzh_temp1 as
select a.*,c.so_man 经办人,c.reg_nbr 经办人号,b.use_name 使用人,b.use_reg_nbr 使用号
from hzh_temp a
left join party.CM_CUSTOMER_INFO_EXT@from_ggkdb1_clone b on a.user_id=b.user_id
left join so1.insx_sogroup_operator_792@from_crmdba1_clone c on a.user_id=c.user_id;
select * from hzh_temp1;
```

### 七月五号

```
怎样解决系统导出的excel表中18位数字后3位自动变为0的问题：
https://zhidao.baidu.com/question/308754276.html
```

```sql
集客线条量酬

drop table hzh_tmp11;
create table hzh_tmp11 as
select a.*,b.offer_id plan_id,b.order_name plan_name,b.state_name
from zt_tmp10 a 
left join zt_user b on a.user_id=b.user_id;

drop table hzh_tmp12;
create table hzh_tmp12 as
select distinct a.*,case when b.user_id is not null then 1 else 0 end flag_5g
from hzh_tmp11 a
left join (select to_number(user_id) user_id from hzh_tmp11 where plan_id in(select offer_id from crm3_dnp_lc_plan_1 where offer_type='5G套餐') /*union 
select user_id from so1.ins_offer_792@from_crmdba1_clone  where offer_id in(212080720876,212080720877,
212080720878,212080720879,310095400425,310095400426,310095400433) and state=1 and expire_date>sysdate*/) b on a.user_id=b.user_id;

select * from zt_tmp10
select * from hzh_tmp12
select * from hzh_tmp13
select * from datamart.mart_group_fee_202105
select * from hjj_bill_202012_tcxtcz
select * from xwp_wc_zy_202106
select * from datamart.mart_int_91005_ms
select * from crm3_dnp_user_yjt_202106
select * from zt_user_broadband_202106
select * from mart_qqt_jsk_detail_dm


drop table hzh_tmp13;
create table hzh_tmp13 as
select distinct a.*,b.arpu_x arpu_dy,c.arpu_x arpu_sy,d.arpu_x arpu_s4
from hzh_tmp12 a
left join datamart.mart_group_fee_202106 b on a.user_id=b.user_id
left join datamart.mart_group_fee_202105 c on a.user_id=c.user_id
left join (select user_id,round(avg(arpu_x),2) arpu_x from (
select * from hjj_bill_202012_tcxtcz union all
select * from hjj_bill_202011_tcxtcz union all
select * from hjj_bill_202010_tcxtcz) group by user_id) d on a.user_id=d.user_id;

drop table hzh_Tmp14;
create table hzh_tmp14 as
select distinct a.*,
case when b.serv_id is not null then 1 else 0 end flag_5gzd,
case when c.user_id is not null then 1 else 0 end flag_yjt,
case when d.serv_id is not null then 1 else 0 end flag_kd,e.if_jtsx
from hzh_tmp13 a
 left join (select serv_id from xwp_wc_zy_202106 a inner join datamart.mart_int_91005_ms b on substr(a.imei,1,8)=b.tac
 where b.is_5g=1) b on a.user_id=b.serv_id
 left join crm3_dnp_user_yjt_202106 c on a.user_id=c.user_id
 left join zt_user_broadband_202106 d on a.user_id=d.user_id
 left join mart_qqt_jsk_detail_dm e on a.phone_id=e.phone_no;

select * from hzh_tmp14;
```



```sql
关于提取浔阳集团拍照用户7月相关数据

select TU16257322029440 集团名称,TU16257322029441 工号姓名,TU16257322029442 成员号码,
TU16257322029443 是否建档,TU16257322029444 成员拍照类型,TU1625732202944_key 成员建档 from datamart.U1625732202944
drop table crm3_hzh_xunyang;
create table crm3_hzh_xunyang as
select b.*,offer_id,res_value,order_name,create_date,EXTRACT(year FROM sysdate) - EXTRACT(year FROM create_date) 网龄年,state_name,is_kd
,is_5g,use_month,term_code from (select TU16257322029440 集团名称,TU16257322029441 工号姓名,TU16257322029442 成员号码,
TU16257322029443 是否建档,TU16257322029444 成员拍照类型,TU1625732202944_key 成员建档 from datamart.U1625732202944) b,crm3_zt_sa where b.成员号码 = phone_id

--select c.*,case when c.offer_id in (select offer_id from crm3_dnp_lc_plan_1 where offer_type='5G套餐') then 1 else 0 end 是否5g套餐   from 
--crm3_hzh_xunyang c 


drop table crm3_hzh_xunyang2;
create table crm3_hzh_xunyang2 as
select e.*,f.是否家庭网,f.是否办理移动会员,case when e.offer_id in (select offer_id from crm3_dnp_lc_plan_1 where offer_type='5G套餐') then 1 else 0 end 是否5g套餐  
from  (select  phone_id,flag_family 是否家庭网,
case when offer_name_ydhy is not null then 1 else 0 end 是否办理移动会员 from zt_jk_user_202107) f right join crm3_hzh_xunyang e on e.成员号码 = f.phone_id

drop table crm3_hzh_xunyang3;
create table crm3_hzh_xunyang3 as
select a.*,case when a.成员号码 = b.bill_id then 1 else 0 end 是否家庭共享,case when c.flow_5g_sa is not null then 1 else 0 end 是否打开SA 
,case when if_jtsx is not null then 1 else 0 end 是否权益领取 from crm3_hzh_xunyang2 a 
left join crm3_dnp_family_gx_202107 b on a.成员号码 = b.bill_id
left join TMP_ZSL_ZC_5GYEWU_MID4 c on a.成员号码 = c.product_no
left join mart_qqt_jsk_detail_dm d on a.成员号码 = d.phone_no

select * from crm3_zt_sa

select * from crm3_hzh_xunyang

select * from zt_jk_user_202107

select * from mart_qqt_jsk_detail_dm          --是否权益领取
select * from crm3_dnp_family_gx_202107      --家庭共享
select * from TMP_ZSL_ZC_5GYEWU_MID4      ---SA
select offer_id,res_value,order_name,create_date,EXTRACT(year FROM sysdate) - EXTRACT(year FROM create_date) 网龄年,state_name,is_kd,case when home_name is not null then 1 else 0 end 是否家庭网 
,case when vnet_name is not null then 1 else 0 end 是否V网,is_5g,use_month,term_code
from crm3_zt_sa;



--DATEDIFF(day,TO_char(sysdate, 'YYYY-MM-DD'),TO_char(create_date, 'YYYY-MM-DD')) 网龄
select ceil((sysdate- create_date)/30)  网龄月份 FROM crm3_zt_sa;
select EXTRACT(year FROM sysdate) - EXTRACT(year FROM create_date) 网龄 from crm3_zt_sa
select * from crm3_zt_sa

select * from mart_qqt_jsk_detail_dm

select count(*) from crm3_hzh_xunyang3

select distinct a.*,b.if_yh,five_type,case when (if_jtw = '0' and if_jtvw = '0') then 0 else 1 end 是否V网 from crm3_hzh_xunyang3 a
left join 
(select case when phone_no1 is null then phone_no2 else phone_no1 end phone_no,if_yh,'A' five_type,if_jtw,if_jtvw from mart_five_ywzk_dm where city_code=792
union all 
select phone_no,if_yh,'B' five_type,if_jtw,if_jtvw from mart_five_wkyh_dm where city_id=792
union all 
select phone_no,if_yh,'C' five_type,if_jtw,if_jtvw from mart_five_whyk_dm where city_id=792
union all 
select product_no as phone_id,if_yh,'D' five_type,if_jtw,if_jtvw from mart_five_gjz_dm where city_id=792
union all 
select case when phone_no1 is null then phone_no2 else phone_no1 end phone_no,if_yh,'E' five_type,if_jtw,if_jtvw from mart_five_gjz_dkc_dm) b on a.成员号码 = b.phone_no


select * from crm3_hzh_xunyang3


----A类异网主卡
select * from mart_five_ywzk_dm where city_code=792  and op_time='2021-07-09'
----B类我宽异号
select * from mart_five_wkyh_dm where city_id=792  and op_time='2021-07-09'
----C类我号异宽用户
select * from mart_five_whyk_dm where city_id=792  and op_time='2021-07-09'
----D类高价值零低黏度客户
select * from mart_five_gjz_dm where city_id=792
----E类高价值单卡槽
select * from mart_five_gjz_dkc_dm
```



### 七月十二号

```sql
庐山市拍照客户相关数据提取
drop table crm3_hzh_lushan;
create table crm3_hzh_lushan as
select a.*,c.state_name,b.plan_name,case when c.weigth < 30 then 1 else 0 end 是否小于30分 from 
(select distinct TU1626071934379_KEY phone_id from datamart.U1626071934379) a
left join 
zt_jk_user_202107 b on a.phone_id = b.phone_id
left join 
crm3_zt_sa c on a.phone_id = c.phone_id


select * from crm3_zt_sa

select distinct a.*,(c.user_consume + d.user_consume + e.user_consume + f.user_consume + g.user_consume + h.user_consume) / 6 as 六个月平均消费
from crm3_hzh_lushan a 
left join  zt_user_fee_202101 c on a.phone_id = c.phone_id
left join  zt_user_fee_202102 d on a.phone_id = d.phone_id
left join  zt_user_fee_202103 e on a.phone_id = e.phone_id
left join  zt_user_fee_202104 f on a.phone_id = f.phone_id
left join  zt_user_fee_202105 g on a.phone_id = g.phone_id
left join  zt_user_fee_202106 h on a.phone_id = h.phone_id

庐山人人通数据
drop table crm3_hzh_lushanRrt;
create table crm3_hzh_lushanRrt as
select a.*,c.state_name,c.order_name,c.is_kd,c.is_hitv from 
(select distinct TU1626167404754_KEY phone_id from datamart.U1626167404754) a 
left join 
crm3_zt_sa c on a.phone_id = c.phone_id
```

### 人人通6月

```sql
drop table crm3_dnp_zw_1122_temp0;
create table crm3_dnp_zw_1122_temp0 as
select '792' region_code,a.county_code,a.serv_id,a.phone_id,bill_cycle,a.user_type,a.cust_id,a.acct_id,a.plan_id,a.fee_item_id,fee 
from crm3_acc_bill_dtl_0792202106 a where    --要改时间
 fee_item_id in(
select item_code from zt_rrt_item1);



drop table crm3_dnp_zw_1122_temp; 
create table crm3_dnp_zw_1122_temp as 
select distinct a.*,c.group_id From 
(select region_code,county_code,serv_id,phone_id,acct_id,fee_item_id,item_name,sum(fee) fee from  (select distinct a.*,b.name item_name 
from crm3_dnp_zw_1122_temp0 a
left join (select distinct * from (select item_id,name from pd.PM_PRICE_EVENT@from_ggkdb1_clone /*union all
select acct_item_type_id item_id,acct_item_type_name name from base.bs_acct_ITEM_type@from_ggkdbb_adg*/)) b on a.fee_item_id=b.item_id)
where user_type!=1
group by region_code,county_code,serv_id,phone_id,acct_id,fee_item_id,item_name)  a,
(select user_id,group_id From SO1.insx_group_order_info@from_crmdba1_clone where city_id=792) c
where a.serv_id=c.user_id(+) union all
select c.*,a.group_id
from SO1.insx_group_order_info@FROM_CRMDBa1_CLONE a,SO1.INS_OFF_INS_USER_792@FROM_CRMDBa1_CLONE b,
(select region_code,county_code,serv_id,phone_id,acct_id,fee_item_id,item_name,sum(fee) fee from  (select distinct a.*,b.name item_name 
from crm3_dnp_zw_1122_temp0 a
left join (select distinct * from (select item_id,name from pd.PM_PRICE_EVENT@from_ggkdb1_clone /*union all
select acct_item_type_id item_id,acct_item_type_name name from base.bs_acct_ITEM_type@from_ggkdbb_adg*/)) b on a.fee_item_id=b.item_id) 
where user_type=1 group by region_code,county_code,serv_id,phone_id,acct_id,fee_item_id,item_name)  c
where a.city_id=792 and a.offer_id in (211200591047,211200591747,211200591888,211200591947) 
and a.offer_ins_id=b.offer_inst_id 
and b.user_id=c.serv_id(+) 
and is_main_offer=0;


drop table crm3_dnp_zw_1122_temp01; 
create table crm3_dnp_zw_1122_temp01 as
select a.*,b.group_id group_id1 from crm3_dnp_zw_1122_temp a,PARTY.CM_GROUP_ACCOUNT@from_ggkdb1_clone b
where a.acct_id=b.acct_id(+);

update crm3_dnp_zw_1122_temp01 set group_id=group_id1 where group_id is null and group_id1 is not null;
commit;

drop table crm3_dnp_zw_1122_temp02; 
create table crm3_dnp_zw_1122_temp02 as
select distinct a.*,c.party_name group_name,c.county_code region_type,d_cty_name(c.county_code)county_name,
b.organization_id,d.state_name,e.unpay_fee04,unpay_fee05,unpay_fee06 from   --改变量
crm3_dnp_zw_1122_temp01 a,PARTY.CB_ORGANIZATION@FROM_GGKDB1_CLONE b,
(select * from PARTY.CB_GROUP_PARTY@FROM_GGKDB1_CLONe where region_code=792) c ,
zt_user d,
(select user_id,
sum(case when billing_cycle_id=202104 then total_fee end)/100 unpay_fee04,----===根据实际需求改时间
sum(case when billing_cycle_id=202105 then total_fee end)/100 unpay_fee05,
sum(case when billing_cycle_id=202106 then total_fee end)/100 unpay_fee06
 from  zt_unpay_fee1 group by user_id)  e
where a.GROUP_ID=b.group_id(+) and 
b.organization_id=c.party_id(+) and 
a.serv_id=d.user_id(+) 
and a.serv_id=e.user_id(+);


---===明细结果
select * from crm3_dnp_zw_1122_temp02 where serv_id is not null and fee!=0;


select distinct * from (
select region_code,county_code,serv_id,phone_id,acct_id,fee_item_id,item_name,fee,state_name,unpay_fee04,unpay_fee05,unpay_fee06  --改变量
from crm3_dnp_zw_1122_temp02 where serv_id is not null and fee!=0);

```

```sql
九江市应急管理局MAS短信明细提取

select * from jf.dr_ismg_l_20210401@jfxdcx where user_number = '10005723305'
drop table crm3_hzh_emergencyManagementBureau;
create table crm3_hzh_emergencyManagementBureau(start_time varchar(60),opp_number varchar(60),条数 varchar(60)，计费金额 varchar(60));

 Declare  
p_bill_date varchar(8);
b_date varchar(8);
e_date varchar(8);                         
m Number(4);
i Number;
begin
  Execute Immediate 'Truncate Table crm3_hzh_emergencyManagementBureau';
b_date:='20210401';
e_date:='20210630';
m:=to_date(e_date,'yyyymmdd')-to_date(b_date,'yyyymmdd');
Loop
p_bill_date  := to_char(to_date(e_date,'yyyymmdd')-m,'yyyymmdd');
 execute immediate 'insert into crm3_hzh_emergencyManagementBureau 
 select a.start_time,a.opp_number,a.条数,a.计费金额 from (select start_time,opp_number,case when opp_number is not null then 1 else 0 end 条数,
 (charge1+charge2+charge3+charge4-charge1_disc-charge2_disc-charge3_disc-charge4_disc) as 计费金额
from jf.dr_ismg_l_'||p_bill_date||'@jfxdcx  where user_number=''10005723305'') a ';
 commit;
 Exit When m=0;
  m:=m-1;
  End Loop;
  End;
  

           select * from crm3_hzh_emergencyManagementBureau;
```

```
提取柘林水电厂3463个IMS固话号码的欠费明细

select TU16261475370880 phone_id,TU16261475370881 用户编号, TU1626147537088_key 账户编号 from datamart.U1626147537088



```

### 提取柘林水电厂3463个IMS固话号码的欠费明细

```sql
提取柘林水电厂3463个IMS固话号码的欠费明细

select a.*,b.实时余额 七月十四余额,c.四月欠费,c.五月欠费,c.六月欠费 from 
(select TU16261475370880 phone_id,TU16261475370881 用户编号, TU1626147537088_key 账户编号 from datamart.U1626147537088) a left join 
crm3_zt_bill_fee_now b on a.phone_id = b.phone_id  left join 
crm3_hzh_test1 c on a.phone_id = c.phone_id 


select * from crm3_zt_bill_fee_now

select * from zt_unpay_fee1 where  bill_id = '07927207178'


select * from crm3_zt_sa where user_id = '400314036931'

select * from zt_unpay_fee where  bill_id = '07927130105'



select a.phone_id as phone_id,
(case billing_cycle_id when 202104 then sum(unpay_fee) else 0 end) as 四月,
(case billing_cycle_id when 202105 then sum(unpay_fee) else 0 end) as 五月,
(case billing_cycle_id when 202106 then sum(unpay_fee) else 0 end) as 六月 from 
(select TU16261475370880 phone_id,TU16261475370881 用户编号, TU1626147537088_key 账户编号 from datamart.U1626147537088) a left join 
zt_unpay_fee1 c on a.用户编号 = c.user_id  group by a.phone_id order by a.phone_id


drop table crm3_hzh_test;
create table crm3_hzh_test as
select distinct  a.phone_id,c.billing_cycle_id,sum(c.unpay_fee) unpay_fee from 
(select TU16261475370880 phone_id,TU16261475370881 用户编号, TU1626147537088_key 账户编号 from datamart.U1626147537088) a left join 
zt_unpay_fee1 c on a.用户编号 = c.user_id group by a.phone_id,c.billing_cycle_id 

select * from crm3_hzh_test

select phone_id,case when unpay_fee = min(billing_cycle_id) then billing_cycle_id else null end from 
crm3_hzh_test group by phone_id

drop table crm3_hzh_test1;
create table crm3_hzh_test1 as
select a.phone_id,
max(case billing_cycle_id when 202104 then unpay_fee/100 else 0 end) as 四月欠费,
max(case billing_cycle_id when 202105 then unpay_fee/100 else 0 end) as 五月欠费,
max(case billing_cycle_id when 202106 then unpay_fee/100 else 0 end) as 六月欠费 from crm3_hzh_test a  group by a.phone_id

drop table crm3_hzh_test4;
create table crm3_hzh_test4 as
select phone_id, 四月欠费,五月欠费,六月欠费,
case when 四月欠费 = greatest(四月欠费,五月欠费,六月欠费) then '四月' 
  when 五月欠费 = greatest(四月欠费,五月欠费,六月欠费) then '五月' 
  when 四月欠费 = greatest(四月欠费,五月欠费,六月欠费) then '六月' else '0' end 最大欠费月份,
case when 四月欠费 = least(四月欠费,五月欠费,六月欠费) then '四月' 
  when 五月欠费 = least(四月欠费,五月欠费,六月欠费) then '五月' 
  when 四月欠费 = least(四月欠费,五月欠费,六月欠费) then '六月' else '0' end 最小欠费月份 from crm3_hzh_test1

select * from crm3_hzh_test4



select * from crm3_hzh_test1;




select phone_id, 四月欠费,五月欠费,六月欠费,greatest(四月欠费,五月欠费,六月欠费)maxV,least(四月欠费,五月欠费,六月欠费)minV from crm3_hzh_test1

```

### 七月十五号

```sql
修水县气象局物联网卡定位  ： 先在zt_gprs_202107这个表里面查看是否在使用，然后查看zt_gprs_202107这个表的存储过程，找到对应的表，下面，找到对应的基站信息

select bill_month,user_number,lac_id,cell_id from jf.dr_ggprs_792_4_20210715@gprsxdcx  where user_number = '15949542484'
```

```sql
取彭泽县文化广电新闻出版旅游局MAS短信2021年5月和6月份的发送记录

select * from jf.dr_ismg_l_20210601@jfxdcx a where user_number = '99273167059'

drop table crm3_hzh_pengzeCulture;
create table crm3_hzh_pengzeCulture(start_time varchar(60),opp_number varchar(60)，message_length varchar(60),条数 varchar(60),计费金额 varchar(60));


Declare  
p_bill_date varchar(8);
b_date varchar(8);
e_date varchar(8);                         
m Number(4);
i Number;
begin
  Execute Immediate 'Truncate Table crm3_hzh_pengzeCulture';
b_date:='20210501';
e_date:='20210630';
m:=to_date(e_date,'yyyymmdd')-to_date(b_date,'yyyymmdd');
Loop
p_bill_date  := to_char(to_date(e_date,'yyyymmdd')-m,'yyyymmdd');
 execute immediate 'insert into crm3_hzh_pengzeCulture 
 select a.start_time,a.opp_number,a.message_length,a.条数,a.计费金额 from (select start_time,opp_number,message_length,case when opp_number is not null then 1 else 0 end 条数,
 (charge1+charge2+charge3+charge4-charge1_disc-charge2_disc-charge3_disc-charge4_disc) as 计费金额
from jf.dr_ismg_l_'||p_bill_date||'@jfxdcx  where user_number=''99273167059'') a ';
 commit;
 Exit When m=0;
  m:=m-1;
  End Loop;
  End;
  
  --select * from crm3_hzh_pengzeCulture;
    --select * from crm3_hzh_peoplesGov;
```

```sql
select b.phone_id,a.state_name,a.order_name,a.organize_name,(a.fee_1 + a.fee_2 + a.fee_3) / 3 as 近三月平均ARPU,(f.rating_res + g.rating_res + h.rating_res)/3 近三月平均流量 
from (select distinct TU1626419208301_KEY phone_id from datamart.U1626419208301) b 
left join crm3_zt_sa a on a.phone_id = b.phone_id
left join  zt_gprs_202104 f on b.phone_id = f.user_number
left join  zt_gprs_202105 g on b.phone_id = g.user_number
left join  zt_gprs_202106 h on b.phone_id = h.user_number


select * from zt_user_fee_202106
select * from zt_gprs_202106 where user_number = '13667922404'

select distinct TU1626419208301_KEY phone_id from datamart.U1626419208301          --国网江西省电力有限公司永修县供电分公司物联网卡流量数据提取申请    
```

```sql
 	关于提取企业视频彩铃到期时间数据的申请
 select * from so1.ins_offer_792@from_crmdba1_clone where order_name like '%彩铃%'
```

### 七月二十号

```sql
警务通
drop table crm3_hzh_policeLink;
create table crm3_hzh_policeLink as
select distinct c.userName,c.department,c.phone_id,d.order_name 是否办理视频彩铃 from 
(select a.*,b.user_id from 
(select distinct TU16267492527480 userName,TU16267492527481 department,TU1626749252748_KEY phone_id from datamart.U1626749252748) a
left join zt_user b on a.phone_id = b.phone_id) c
left join (select * from so1.ins_offer_792@from_crmdba1_clone  where order_name like '%彩铃%') d 
on c.user_id = d.user_id 
```

```sql
国网江西省电力有限公司永修县供电分公司物联网卡流量数据和消费
select distinct b.phone_id,a.state_name,a.order_name,a.organize_name,(a.fee_1 + a.fee_2 + a.fee_3) / 3 as 近三月平均ARPU,(f.rating_res + g.rating_res + h.rating_res)/3 近三月平均流量 
,a.fee_1 六月消费, a.fee_2 五月消费, a.fee_3 四月消费 from (select distinct TU1626764152980_KEY phone_id from datamart.U1626764152980) b 
left join crm3_zt_sa a on a.phone_id = b.phone_id
left join  zt_gprs_202104 f on b.phone_id = f.user_number
left join  zt_gprs_202105 g on b.phone_id = g.user_number
left join  zt_gprs_202106 h on b.phone_id = h.user_number
```

```sql
九钢用户办理的预存活动及促销活动的所有明细  
注：select * from zt_vpmn_product中name就是资费名称

select distinct TU1627026643740_KEY phone_id from datamart.U1627026643740


--drop table crm3_hzh_steel2;
--create table crm3_hzh_steel2(company varchar(20),phone_id varchar(20));
select * from crm3_hzh_steel
select * from crm3_hzh_steel2


select * from xg.sys_city@from_ggkdb1_clone 
select b.*,a.order_name,a.order_name_next,a.state_name,a.county_name,a.is_kd,a.user_id
from crm3_zt_sa a right join (select distinct TU1627026643740_KEY phone_id from datamart.U1627026643740) b on a.phone_id = b.phone_id
--彩铃
select * from so1.ins_offer_792@from_crmdba1_clone where state = 1 and expire_date>sysdate and offer_id = '212035012000'
--宽带
select * from zt_user_broadband

--宽带促销名称
select d.*,c.产品名称 as 宽带促销名称 from zt_user_broadband c right join (select b.*,a.order_name,a.order_name_next,a.state_name,a.county_name,a.is_kd,a.user_id
from crm3_zt_sa a right join (select distinct TU1627026643740_KEY phone_id from datamart.U1627026643740) b on a.phone_id = b.phone_id) d on c.号码 = d.phone_id and d.phone_id is not null

--添加是否彩铃
drop table crm3_hzh_crbt1;
create table crm3_hzh_crbt1 as
select m.*,case when m.user_id = n.user_id then 1 else 0 end 是否彩铃 from (select * from so1.ins_offer_792@from_crmdba1_clone where state = 1 and expire_date>sysdate and offer_id = '212035012000') n right join 
(select d.*,c.产品名称 as 宽带促销名称 from zt_user_broadband c right join (select b.*,a.order_name,a.order_name_next,a.state_name,a.county_name,a.is_kd,a.user_id
from crm3_zt_sa a right join (select distinct TU1627026643740_KEY phone_id from datamart.U1627026643740) b on a.phone_id = b.phone_id) d on c.号码 = d.phone_id and d.phone_id is not null
) m on m.user_id = n.user_id

select * from crm3_hzh_crbt1

--集团网 
select * from zt_vpmn_product
select * from so1.ins_prod_792@from_crmdba1_clone
select p.*,o.user_id from so1.ins_prod_792@from_crmdba1_clone o right join  zt_vpmn_product p on  o.prod_id = p.product_item_id

select * from crm3_zt_sa

select z.*,h.name,case when z.user_id = h.user_id then 1 else 0 end 是否集团网 from crm3_hzh_crbt1 z left join 
(select p.*,o.user_id from so1.ins_prod_792@from_crmdba1_clone o right join  zt_vpmn_product p on  o.prod_id = p.product_item_id) h on 
z.user_id = h.user_id

drop table crm3_hzh_jiugang1;
create table crm3_hzh_jiugang1 as 
select z.*,h.name,case when z.user_id = h.user_id then 1 else 0 end 是否集团网 from crm3_hzh_crbt1 z left join 
(select p.*,o.user_id from so1.ins_prod_792@from_crmdba1_clone o right join  zt_vpmn_product p on  o.prod_id = p.product_item_id) h on 
z.user_id = h.user_id

select distinct * from crm3_hzh_jiugang1


select a.*,b.order_name 所有有效活动押金明细,b.offer_id from crm3_hzh_jiugang1 a left join 
(select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate) b 
on a.user_id = b.user_id
```

### 七月二十六号

```sql
关于提取供电物联卡消费的申请
drop table crm3_hzh_july;
create table crm3_hzh_july as
select a.phone_id,b.order_name,b.state_name,case when b.实时余额 < 0 then '是' else '否' end 是否欠费,b.fee_now 七月消费,e.rating_res 五月流量,f.rating_res 六月流量,g.rating_res 七月流量,b.user_id from 
(select distinct TU1627267739595_KEY phone_id from datamart.U1627267739595) a left join 
crm3_zt_sa b on a.phone_id = b.phone_id
left join  zt_gprs_202105 e on a.phone_id = e.user_number
left join  zt_gprs_202106 f on a.phone_id = f.user_number
left join  zt_gprs_202107 g on a.phone_id = g.user_number;

select * from zt_user_fee_202106
select * from zt_gprs_202106

select * from crm3_hzh_july

select a.*,b.order_name,c.col16 from crm3_hzh_july a left join 
(select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate) b
on a.user_id = b.user_id
left join qdres.rs_obj_inst_used_11_792@NEW_BBCXDB c on a.phone_id = c.col29

select * from qdres.rs_obj_inst_used_11_792@NEW_BBCXDB where col16='898600F9142032036878';
```

```sql
	关于国网江西省电力有限公司瑞昌市分公司行业卡数据提取的申请
select distinct TU1627349651248_KEY phone_id from datamart.U1627349651248

select * from crm3_zt_bill_fee_now

--drop table crm3_hzh_temp;
create table crm3_hzh_temp as
select distinct a.*,case when b.unpay_fee > 0 then '是' else '否' end 是否欠费 from (select a.phone_id,b.state_name,b.user_id from  (select distinct TU1627349651248_KEY phone_id from datamart.U1627349651248) a left join
 crm3_zt_sa b on a.phone_id = b.phone_id ) a left join  zt_unpay_fee1 b on a.user_id = b.user_id
 
 select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate

select * from crm3_hzh_temp

select a.*,b.order_name,b.create_op_id,b.offer_id from crm3_hzh_temp a left join (select * from so1.ins_offer_792@from_crmdba1_clone where expire_date>sysdate) b
on a.user_id = b.user_id

select a.*,b.plan_name from crm3_hzh_temp a left join zt_paas_user_base_d b on a.phone_id = b.serv_no
select * from zt_paas_user_base_d

--用于查找相应的套餐详情
select * from pd.pm_product_offering@jxcs_clone where product_offering_id = '80000936'

--转换表    product_item_id 等于offer_id,extend_id 等于product_offering_id
select * from product.up_product_item@from_ggkdb1_clone

drop table crm3_hzh_ruicangAll;
create table crm3_hzh_ruicangAll as
select f.*,g.extend_id from (select a.*,b.order_name,b.create_op_id,b.offer_id from crm3_hzh_temp a left join (select * from so1.ins_offer_792@from_crmdba1_clone where expire_date>sysdate) b
on a.user_id = b.user_id) f left join product.up_product_item@from_ggkdb1_clone g
on f.offer_id = g.product_item_id

select z.*,h.description from crm3_hzh_ruicangAll z left join 
pd.pm_product_offering@jxcs_clone h on extend_id = product_offering_id
```

```sql
九江公司存量物联网卡折扣到期明细数据提取
--存量电话号码
select distinct TU1627447896962_KEY phone_id from datamart.U1627447896962

select a.phone_id,b.state_name,b.user_id from (select distinct TU1627447896962_KEY phone_id from datamart.U1627447896962) a 
left join  crm3_zt_sa b on a.phone_id = b.phone_id

drop table crm3_hzh_yj;
create table crm3_hzh_yj as
select a.*,b.offer_id,b.order_name,b.expire_date,b.effective_date from (select a.phone_id,b.state_name,b.user_id from (select distinct TU1627447896962_KEY phone_id from datamart.U1627447896962) a 
left join  crm3_zt_sa b on a.phone_id = b.phone_id) a left join (select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate and state=1) b
on a.user_id = b.user_id

select a.*,case when a.offer_id in (select TU1627448450361_KEY offer_id from datamart.U1627448450361) then '是' else '否' end 是否办理相关押金,b.cond_id
from crm3_hzh_yj a left join (select TU16274484503610 cond_id,TU16274484503611 cond_name, TU1627448450361_KEY offer_id from datamart.U1627448450361) b
on a.offer_id = b.offer_id


--押金代码
select TU16274484503610 cond_id,TU16274484503611 cond_name, TU1627448450361_KEY offer_id from datamart.U1627448450361
--押金
select * from so1.ins_offer_792@from_crmdba1_clone where offer_type='OFFER_VAS_PREPAY' and expire_date>sysdate and state=1
```

